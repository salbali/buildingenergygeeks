<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="The target of the IHCP is to estimate a heat flow from temperature measurements">
<meta name="keywords" content="material,  keyword1, keyword2, keyword3">
<title>The inverse heat conduction problem | Data science for building energy performance</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-teal.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="buildingenergygeeks" href="http://localhost:4000/feed.xml">

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Building Energy Geeks</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="index_data.html">Home</a></li>
                
                
                
                <li><a href="http://discourse.buildingenergygeeks.org/" target="_blank" rel="noopener">Forum</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Categories<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="index_data.html">Data analysis</a></li>
                        
                        
                        
                        <li><a href="index_hhtb.html">Handbook of heat transfer in buildings</a></li>
                        
                        
                        
                        <li><a href="index_ebe.html">EBE clim (fr)</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="http://simonrouchier.org/" target="_blank" rel="noopener">Author's page</a></li>
                        
                        
                        
                        <li><a href="https://github.com/srouchier/buildingenergygeeks" target="_blank" rel="noopener">GitHub</a></li>
                        
                        
                        
                        <li><a href="https://locie.github.io/bayreb/" target="_blank" rel="noopener">BAYREB project</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="The inverse heat conduction problem">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">Contents </li>
  
  
  
      
  
  <li>
      <a title="Energy performance assessment" href="#">Energy performance assessment</a>
      <ul>
          
          
          
          <li><a title="Energy signature" href="epa_es.html">Energy signature</a></li>
          
          
          
          
          
          
          <li><a title="Linear regression" href="epa_lr.html">Linear regression</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="State-space models" href="#">State-space models</a>
      <ul>
          
          
          
          <li><a title="Overview" href="ssm_overview.html">Overview</a></li>
          
          
          
          
          
          
          <li><a title="The most simple RC model" href="ssm_rc.html">The most simple RC model</a></li>
          
          
          
          
          
          
          <li><a title="The Kalman filter" href="ssm_kalman.html">The Kalman filter</a></li>
          
          
          
          
          
          
          <li><a title="The pySIP library" href="ssm_pysip.html">The pySIP library</a></li>
          
          
          
          
          
          
          <li><a title="Latent force models" href="ssm_lfm.html">Latent force models</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Material characterisation" href="#">Material characterisation</a>
      <ul>
          
          
          
          <li class="active"><a title="Inverse heat conduction problem" href="mat_ihcp.html">Inverse heat conduction problem</a></li>
          
          
          
          
          
          
          <li><a title="Hygric characterisation" href="mat_hygric.html">Hygric characterisation</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">The inverse heat conduction problem</h1>
</div>



<div class="post-content">

   
    <div class="summary">The target of the IHCP is to estimate a heat flow from temperature measurements</div>
   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

    <a target="_blank" rel="noopener" href="https://github.com/srouchier/buildingenergygeeks/blob/gh-pages/pages/data/mat_ihcp.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

   <p>This page is a tutorial on how to solve the inverse heat conduction problem (IHCP) with Python code. It is mostly based on <a href="http://www.techniques-ingenieur.fr/base-documentaire/energies-th4/transferts-thermiques-42214210/problemes-inverses-en-diffusion-thermique-be8266/">this series of articles</a> (in French) that give a great introduction to inverse problems in heat transfer.</p>

<h2 id="introduction">Introduction</h2>

<p>The physical problem is 1D transient heat flow in a finite wall:</p>

<p><img src="images/data/mat_ihcp1.png" style="width: 220px;" /></p>

<p>The problem is one-dimensional heat conduction inside a wall of thermal conductivity <script type="math/tex">\lambda</script> and thickness <script type="math/tex">e</script>. One boundary is subjected to a heat flow <script type="math/tex">u</script> while the other boundary is either insulated (<script type="math/tex">h=0</script>) or open (<script type="math/tex">h>0</script>). A temperature sensor is placed at a certain location <script type="math/tex">x_s</script> within the medium. The initial temperature is uniform <script type="math/tex">T_0 = 0^{\circ}C</script>.</p>

<p>If the heat input <script type="math/tex">u</script> and the material properties are known, calculating the evolution of temperature is straightforward, and may even have an exact analytical solution under some assumptions. On the opposite, the <strong>inverse</strong> heat conduction problem is the estimation of the time-varying boundary heat flow from noisy temperature measurements.</p>

<p><img src="images/data/mat_ihcp2.png" style="width: 700px;" /></p>

<p>The input to the inverse problem are measurements of temperature, which may have been recorded anywhere within the wall (see left panel of the figure above). The target is to reconstruct the history of the heat flow on the left boundary of the wall (see right panel of the figure above). We assume that the thermal conductivity <script type="math/tex">\lambda</script> and sensor position <script type="math/tex">x_s</script> are known.</p>

<p>Since the heat flow is a function of time, the trick to make it identifiable by the inverse problem is to parameterise it into a finite set of <script type="math/tex">n</script> elementary functions <script type="math/tex">f_j</script>:</p>

<script type="math/tex; mode=display">u\left(t\right) = \sum_{j=1}^{n}{u_j f_j(t)}</script>

<p>Hence, the problem actually has <script type="math/tex">n</script> unknowns, assembled into a vector <strong>u</strong> = <script type="math/tex">[u_j; j \in \{1...n\}]</script>. The proper choice for the number of elementary functions is not really the topic of this tutorial, although it is <a href="http://www.techniques-ingenieur.fr/base-documentaire/energies-th4/transferts-thermiques-42214210/problemes-inverses-en-diffusion-thermique-be8266/">an important issue</a>.</p>

<h2 id="background">Background</h2>

<h3 id="model">Model</h3>

<p>The physical model is the 1D heat conduction equation in a finite medium of heat capacity <script type="math/tex">\rho c_p</script> and conductivity <script type="math/tex">\lambda</script>:</p>

<script type="math/tex; mode=display">\rho c_p \frac{\partial T}{\partial t} = \lambda \frac{ \partial^2 T}{\partial x^2}</script>

<p>Assorted with the following boundary conditions: a prescribed heat flow <script type="math/tex">u(t)</script> on the left boundary and a type-3 condition <script type="math/tex">(h, T_\infty)</script> on the right boundary</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
-\lambda \dfrac{\partial T}{\partial x} & = u\left(t\right) & \quad \mathrm{if} \quad x = 0 \\
-\lambda \dfrac{\partial T}{\partial x} & = h \left(T-T_\infty\right) & \quad \mathrm{if} \quad x = e
\end{align} %]]></script>

<h3 id="discretisation">Discretisation</h3>

<p>In order to solve the conservation equation by the finite difference method, the medium is discretised into <script type="math/tex">N</script> equally spaced nodes. The temperature at each node may be assembled into a matrix:</p>

<script type="math/tex; mode=display">\mathbf{T} = \left[T_1(t) \; T_2(t) \; ... \; T_N(t) \right]</script>

<p>where the time is also discretised: <script type="math/tex">t \in \{t_0, t_1... t_k, t_{k+1}... t_K\}</script>. The size of the entire temperature matrix of the problem is then <script type="math/tex">[K \times N]</script>.</p>

<p>This discretisation allows summarizing the conservation equation</p>

<script type="math/tex; mode=display">\frac{\mathrm{d} \mathbf{T}}{\mathrm{d} t} = \mathbf{A} \mathbf{T} + \mathbf{b}u\left(t\right)</script>

<p>with the <strong>A</strong> and <strong>b</strong> matrices defined as follows</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
\mathbf{A} & = \frac{a}{\Delta x^2}
\left[ \begin{array}{ccccc}
-2 & 2 & 0 & ... & 0 \\
1 & -2 & 1 & & 0 \\
0 & & & & \\
... & & 1 & -2 & 1 \\
0 & ... & 0 & 2 & -2\left(1+\mathrm{Bi}\right) \\
\end{array} \right]
\end{align} %]]></script>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
\mathbf{b} & = \frac{2}{\rho c_p \Delta x}
\left[ \begin{array}{c}
1 \\
0 \\
... \\
0 \\
\end{array} \right]
\end{align} %]]></script>

<p>where <script type="math/tex">a=\lambda / \rho c_p</script> is the thermal diffusivity and <script type="math/tex">\mathrm{Bi}=h\Delta x/\lambda</script> is the Biot number.</p>

<h3 id="inverse-problem-solving-u-from-t">Inverse problem: solving <script type="math/tex">u</script> from <script type="math/tex">T</script></h3>

<p>The temperature is not known through the entire wall, but only at a specific sensor position <script type="math/tex">x_s</script>. Knowing the vector of temperature measurements on this spot <script type="math/tex">\mathbf{T}_\mathrm{obs}</script> (size <script type="math/tex">[K \times 1]</script>), the heat flow <script type="math/tex">u(t)</script> may be computed by inversing the linear system of equations:</p>

<script type="math/tex; mode=display">\begin{equation}
\mathbf{T}_\mathrm{obs} = \mathbf{T}(x_s,t) = \mathbf{S} \; \mathbf{u}
\end{equation}</script>

<p>where <strong>S</strong> is the sensitivity matrix of size <script type="math/tex">[K \times n]</script>:</p>

<script type="math/tex; mode=display">S_{kj} = \mathbf{C} \int_{t_0}^{t_k}{\exp\left[\mathbf{A}\left(t_k-\tau\right)\right]\mathbf{b}f_j\left(\tau\right)\mathrm{d}\tau}</script>

<p>Note that this is only valid in the specific conditions <script type="math/tex">\mathbf{T}(t_0)=T_\infty=0^\circ C</script>. In this expression, the vector <strong>C</strong> (size <script type="math/tex">[1 \times N])</script> points to the sensor position within the grid (its only non-zero value is at the position of the sensor <script type="math/tex">x_s</script> in the space discretisation):</p>

<script type="math/tex; mode=display">\mathbf{C} = \left[0 \; 0 \; ... \; 1 \; ... \; 0 \right]</script>

<p>Since the sensitivity matrix is certainly not square (unless we are doing something wrong), the inversion of the linear system yields the final expression for the heat flow:</p>

<script type="math/tex; mode=display">\mathbf{u} = \left[\left(\mathbf{S}^T\mathbf{S}\right)^{-1}\mathbf{S}^T \right] \mathbf{T}_\mathrm{obs}</script>

<p>And that’s it for the math. Now let’s look at some code.</p>

<h2 id="python-code">Python code</h2>

<h3 id="physical-specifications">Physical specifications</h3>
<p>Let’s start with generic conditions of the problem: the space discretisation, material properties, initial and boundary conditions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># Space discretisation
</span><span class="n">N</span> <span class="o">=</span> <span class="mi">21</span>                  <span class="c1"># number of nodes in the mesh
</span><span class="n">delta_x</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># spacing between nodes
</span>
<span class="c1"># Material properties
</span><span class="n">lambda_</span> <span class="o">=</span> <span class="mf">0.3</span>           <span class="c1"># heat conductivity
</span><span class="n">rho_cp</span>  <span class="o">=</span> <span class="mf">1.2e6</span>         <span class="c1"># heat capacity
</span><span class="n">a</span> <span class="o">=</span> <span class="n">lambda_</span> <span class="o">/</span> <span class="n">rho_cp</span>    <span class="c1"># heat diffusivity
</span>
<span class="c1"># Initial and boundary conditions
</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c1"># surface transfer coefficient on the right boundary
</span><span class="n">T_initial</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># initial temperature
</span><span class="n">Biot</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">delta_x</span> <span class="o">/</span> <span class="n">lambda_</span>
</code></pre></div></div>

<h3 id="input-data">Input data</h3>
<p>Measurements are provided in a separate .txt file (available in the repository).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">data_</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/ihcp_data.txt'</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>
<span class="n">time_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_</span><span class="p">[</span><span class="s">'t (s)'</span><span class="p">])</span>    <span class="c1"># time discretisation
</span><span class="n">K</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span>                  <span class="c1"># number of time steps
</span></code></pre></div></div>

<p>The main input to the inverse problem are the temperature measurements. In order to make things more interesting, we decide to add some measurement noise in the form of a normal random component of fixed standard deviation. Studying the influence of this noise on the accuracy of the solution is quite interesting, and you may do exactly that with this code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T_obs</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_</span><span class="p">[</span><span class="s">'T(e/2)'</span><span class="p">])</span>
<span class="n">T_obs</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">T_obs</span><span class="p">))</span>
</code></pre></div></div>

<p>We just chose the temperature recorded in the middle of the wall <code class="language-plaintext highlighter-rouge">T(e/2)</code> as the input to the inverse problem. Hence, the <strong>C</strong> matrix involved in the sensitivity matrix must be defined accordingly:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">C</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="setting-up-the-system">Setting up the system</h3>

<p>In building the system of linear equations, let us start with the A and b matrices defined above:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">diag_moy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">diag_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">diag_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">diag_moy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Biot</span>
<span class="n">diag_sup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+=</span> <span class="mi">1</span>
<span class="n">diag_inf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">delta_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diag_moy</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diag_inf</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diag_sup</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">rho_cp</span> <span class="o">*</span> <span class="n">delta_x</span><span class="p">)</span>
</code></pre></div></div>

<p>Next, let’s define the elementary functions <script type="math/tex">f_j</script> that are used to parameterise <strong>u</strong> into a finite number of unknowns. I chose <a href="https://en.wikipedia.org/wiki/Triangular_function">hat functions</a> because why not.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">20</span>                                  <span class="c1"># number of modes for the discretisation of u
</span><span class="n">time_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">)</span>   <span class="c1"># time discretisation of u
</span>
<span class="k">def</span> <span class="nf">f_hat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">time_n</span><span class="p">):</span>
    <span class="s">"""
    Hat function #j defined on a time grid t_vector
    t: global time scale
    time_n: time scale of the discretisation for u
    j: position of the f_hat function on the t_vector scale (1 &lt;= j &lt;= n)
    """</span>

    <span class="n">delta_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">f_rise</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">time_n</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta_t</span>
    <span class="n">f_decr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">time_n</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta_t</span>

    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">is_rise</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_rise</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">time_n</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">time_n</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_n</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">is_decr</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_decr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">time_n</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">time_n</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">f_rise</span> <span class="o">*</span> <span class="n">is_rise</span> <span class="o">+</span> <span class="n">f_decr</span> <span class="o">*</span> <span class="n">is_decr</span>
</code></pre></div></div>

<p>The last step, and not the least, into building the equation system, is to write the sensitivity matrix.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The initial time t0 doesnt appear in S, so the matrix has one less line
</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">expm</span>
<span class="n">time_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>

    <span class="n">tau</span>   <span class="o">=</span> <span class="n">time_</span><span class="p">[:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">f_tau</span> <span class="o">=</span> <span class="n">f_hat</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">time_n</span><span class="p">)</span>
        <span class="c1"># Calculate an integral for each value of S
</span>        <span class="n">foo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)):</span>
            <span class="c1"># This is a scalar
</span>            <span class="n">foo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">expm</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="p">(</span><span class="n">time_</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">-</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">b</span><span class="p">))</span> <span class="o">*</span> <span class="n">f_tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">S</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="solving">Solving</h3>

<p>The system is now defined, and the last thing to do is to solve it. The vector <strong>u</strong> is found directly by (sort of) inversing the sensitivity matrix:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">T_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
</code></pre></div></div>

<p>And finally, the actual value of the heat flow is found by going through the elementary functions <script type="math/tex">f_j</script> again:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">+=</span> <span class="n">u_modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">f_hat</span><span class="p">(</span><span class="n">time_</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">time_n</span><span class="p">)</span>
</code></pre></div></div>

<p>Our work here is done. We may now compare our results with the target value of the heat flow.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u_true</span> <span class="o">=</span> <span class="n">data_</span><span class="p">[</span><span class="s">'U (W/m2)'</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_</span><span class="p">,</span> <span class="n">u_true</span><span class="p">,</span> <span class="s">'-k'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s">'or-'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time (s)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Heat flow (W/m2)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s">'Target'</span><span class="p">,</span> <span class="s">'Estimated'</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="images/data/mat_ihcp_output.png" style="width: 300px;" /></p>

<p>As far as real-world inverse problems go, this is a pretty good estimate. An interesting study would now be to look at the influence of a few hypotheses on the quality of the estimation of <strong>u</strong>:</p>
<ul>
  <li>the magnitude of the noise;</li>
  <li>the number of modes <script type="math/tex">n</script> versus the measurement sampling time <script type="math/tex">K</script>;</li>
  <li>the position of the sensor…
Should such difficulties add up and compromise the accuracy of the identification, regularisation may quickly become essential.</li>
</ul>


    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        
        
    </div>




</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2020 USMB. All rights reserved. <br />
<span>Page last updated:</span> March 29, 2020<br/> Site last generated: Apr 7, 2020 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
